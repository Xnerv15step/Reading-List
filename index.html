<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8">
  <title>æ›¸ç±æ¸…å–®</title>
  <!-- å¼•å…¥å¤–éƒ¨æ¨£å¼è¡¨ -->
  <link rel="stylesheet" href="css/style.css">
</head>

<body>

  <!-- ==========================================
       é é¢ä¸»æ¨™é¡Œ
       ã€Œæ¸…å–®ã€ç”¨ <span> åŒ…ä½ï¼Œè®“ CSS å¯ä»¥å–®ç¨ä¸Šè‰²
  =========================================== -->
  <h1>æ›¸ç± <span>æ¸…å–®</span></h1>


  <!-- ==========================================
       çµ±è¨ˆé¢æ¿
       é¡¯ç¤ºã€Œç¸½è¨ˆ / å·²è®€ / é€²è¡Œä¸­ / å¾…è®€ã€å››å€‹æ•¸å­—ã€‚
       æ•¸å­— idï¼ˆs-total ç­‰ï¼‰ç”± JS çš„ updateStats() å‹•æ…‹å¯«å…¥ã€‚
  =========================================== -->
  <div class="stats">

    <div class="stat-card total">
      <div class="val" id="s-total">0</div> <!-- æ‰€æœ‰æ›¸ç±ç¸½æ•¸ -->
      <div class="lbl">ç¸½è¨ˆ</div>
    </div>

    <div class="stat-card read">
      <div class="val" id="s-read">0</div> <!-- status === "read" çš„æ•¸é‡ -->
      <div class="lbl">å·²è®€</div>
    </div>

    <div class="stat-card prog">
      <div class="val" id="s-prog">0</div> <!-- status === "in-progress" çš„æ•¸é‡ -->
      <div class="lbl">é€²è¡Œä¸­</div>
    </div>

    <div class="stat-card toread">
      <div class="val" id="s-tor">0</div> <!-- status === "to-read" çš„æ•¸é‡ -->
      <div class="lbl">å¾…è®€</div>
    </div>

  </div>


  <!-- ==========================================
       å·¥å…·åˆ—
       åŒ…å«ï¼šé—œéµå­—æœå°‹ã€ç‹€æ…‹ç¯©é¸ã€è©•åˆ†ç¯©é¸ã€æ–°å¢æŒ‰éˆ•ã€‚
       æ¯å€‹æ§åˆ¶å…ƒä»¶è§¸ç™¼ applyFilter() å³æ™‚é‡æ–°éæ¿¾è¡¨æ ¼ã€‚
  =========================================== -->
  <div class="toolbar">

    <!-- æœå°‹æ¬„ï¼šåœ–ç¤ºä»¥ .ico span çµ•å°å®šä½åœ¨è¼¸å…¥æ¡†å·¦å´ -->
    <div class="search-wrap">
      <span class="ico">ğŸ”</span>
      <input id="searchInput" type="text" placeholder="æœå°‹æ›¸åã€ä½œè€…ã€é¡åˆ¥â€¦" oninput="applyFilter()" <!-- æ¯æ¬¡éµå…¥ç«‹å³ç¯©é¸ -->
      >
    </div>

    <!-- ç‹€æ…‹ç¯©é¸ä¸‹æ‹‰é¸å–®ï¼›value="" ä»£è¡¨ã€Œä¸é™ç‹€æ…‹ã€ -->
    <select class="filter-select" id="filterStatus" onchange="applyFilter()">
      <option value="">å…¨éƒ¨ç‹€æ…‹</option>
      <option value="read">å·²è®€</option>
      <option value="in-progress">é€²è¡Œä¸­</option>
      <option value="to-read">å¾…è®€</option>
    </select>

    <!-- è©•åˆ†ç¯©é¸ä¸‹æ‹‰é¸å–®
         value="3" â†’ rate >= 3
         value="2" â†’ rate >= 2
         value="1" â†’ rate >= 1
         value="0" â†’ rate === 0ï¼ˆå°šæœªè©•åˆ†ï¼‰
         value=""  â†’ ä¸é™è©•åˆ† -->
    <select class="filter-select" id="filterRate" onchange="applyFilter()">
      <option value="">å…¨éƒ¨è©•åˆ†</option>
      <option value="3">â­â­â­ ä¸‰é¡†</option>
      <option value="2">â­â­ äºŒé¡†ä»¥ä¸Š</option>
      <option value="1">â­ ä¸€é¡†ä»¥ä¸Š</option>
      <option value="0">å°šæœªè©•åˆ†</option>
    </select>

    <!-- é–‹å•Ÿæ–°å¢æ›¸ç± Modalï¼›ä¸å‚³åƒæ•¸ï¼ŒopenModal() é è¨­ idx = -1 -->
    <button class="btn-add" onclick="openModal()">ï¼‹ æ–°å¢æ›¸ç±</button>

  </div>


  <!-- ==========================================
       ä¸»è¡¨æ ¼
       è¡¨é ­é»æ“Šæ¬„ä½å¯æ’åºï¼ˆå‘¼å« sortTable(æ¬„ä½ç´¢å¼•)ï¼‰ã€‚
       tbody#tbody ç”± render() å‹•æ…‹ç”¢ç”Ÿï¼ŒHTML ä¸­ä¸é å¡«è³‡æ–™åˆ—ã€‚
  =========================================== -->
  <table id="bookTable">
    <thead>
      <tr>
        <!-- å„æ¬„ç´¢å¼•ï¼š0=æ›¸å, 1=ä½œè€…, 2=é¡åˆ¥, 3=ç‹€æ…‹, 4=è©•åˆ† -->
        <th onclick="sortTable(0)">æ›¸å <span class="sort-icon">â†•</span></th>
        <th onclick="sortTable(1)">ä½œè€… <span class="sort-icon">â†•</span></th>
        <th onclick="sortTable(2)">é¡åˆ¥ <span class="sort-icon">â†•</span></th>
        <th onclick="sortTable(3)">ç‹€æ…‹ <span class="sort-icon">â†•</span></th>
        <th onclick="sortTable(4)">è©•åˆ† <span class="sort-icon">â†•</span></th>
        <th>æ“ä½œ</th><!-- æ“ä½œæ¬„ä¸å¯æ’åºï¼Œä¸åŠ  onclick -->
      </tr>
    </thead>
    <tbody id="tbody">
      <!-- ç”± render() å‹•æ…‹æ³¨å…¥ <tr> åˆ— -->
    </tbody>
  </table>


  <!-- ==========================================
       Toast æç¤ºè¨Šæ¯
       å›ºå®šåœ¨å³ä¸‹è§’ï¼ŒJS é€é .show class æ§åˆ¶æ·¡å…¥æ·¡å‡ºã€‚
  =========================================== -->
  <div class="toast" id="toast">âœ“ å·²è‡ªå‹•å„²å­˜</div>


  <!-- ==========================================
       Modal å°è©±æ¡†ï¼ˆæ–°å¢ / ç·¨è¼¯æ›¸ç±ï¼‰
       .overlay ä½œç‚ºåŠé€æ˜é®ç½©ï¼Œé»æ“Šé®ç½©æœ¬èº«å¯é—œé–‰ã€‚
       åŠ ä¸Š .open class â†’ display: flex ä½¿å…¶é¡¯ç¤ºã€‚
  =========================================== -->
  <div class="overlay" id="overlay">
    <div class="modal">

      <!-- æ¨™é¡Œç”± openModal() å‹•æ…‹è¨­ç‚ºã€Œæ–°å¢æ›¸ç±ã€æˆ–ã€Œç·¨è¼¯æ›¸ç±ã€ -->
      <h2 id="modalTitle">æ–°å¢æ›¸ç±</h2>

      <!-- æ›¸åï¼ˆå¿…å¡«ï¼ŒsaveBook() æœƒé©—è­‰ä¸å¯ç©ºç™½ï¼‰ -->
      <div class="form-group">
        <label>æ›¸å</label>
        <input id="f-title" type="text" placeholder="è«‹è¼¸å…¥æ›¸å">
      </div>

      <!-- ä½œè€… -->
      <div class="form-group">
        <label>ä½œè€…</label>
        <input id="f-author" type="text" placeholder="è«‹è¼¸å…¥ä½œè€…">
      </div>

      <!-- é¡åˆ¥ -->
      <div class="form-group">
        <label>é¡åˆ¥</label>
        <input id="f-genre" type="text" placeholder="å°èªªã€æ¨ç†ã€å¥‡å¹»â€¦">
      </div>

      <!-- é–±è®€ç‹€æ…‹ä¸‹æ‹‰é¸å–® -->
      <div class="form-group">
        <label>ç‹€æ…‹</label>
        <select id="f-status">
          <option value="read">å·²è®€</option>
          <option value="in-progress">é€²è¡Œä¸­</option>
          <option value="to-read">å¾…è®€</option>
        </select>
      </div>

      <!-- æ˜Ÿæ˜Ÿè©•åˆ†é¸æ“‡å™¨ï¼ˆ0â€“3 é¡†ï¼‰
           data-vï¼šè©²æŒ‰éˆ•ä»£è¡¨çš„åˆ†å€¼ã€‚
           setStar(v)ï¼šé»åŒä¸€é¡†å¯å–æ¶ˆï¼ˆæ­¸é›¶ï¼‰ï¼Œå¦å‰‡è¨­ç‚º vã€‚ -->
      <div class="form-group">
        <label>è©•åˆ†(0~3é¡†)</label>
        <div class="star-picker">
          <button class="star-btn" data-v="1" onclick="setStar(1)">â—</button>
          <button class="star-btn" data-v="2" onclick="setStar(2)">â—</button>
          <button class="star-btn" data-v="3" onclick="setStar(3)">â—</button>
        </div>
      </div>

      <!-- åº•éƒ¨æ“ä½œæŒ‰éˆ• -->
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn-save" onclick="saveBook()">å„²å­˜</button>
      </div>

    </div>
  </div>


  <script>
    // ============================================================
    // å¸¸æ•¸
    // ============================================================

    // ç‹€æ…‹è‹±æ–‡ key â†’ ä¸­æ–‡é¡¯ç¤ºæ¨™ç±¤ï¼ˆç”¨æ–¼ render è¡¨æ ¼ & çµ±è¨ˆï¼‰
    const STATUS_LABEL = {
      "read": "å·²è®€",
      "in-progress": "é€²è¡Œä¸­",
      "to-read": "å¾…è®€"
    };

    // æ’åºæ™‚å„ç‹€æ…‹çš„æ•¸å­—æ¬Šé‡ï¼ˆæ•¸å­—è¶Šå°æ’è¶Šå‰é¢ï¼‰
    const STATUS_ORDER = { "å·²è®€": 0, "é€²è¡Œä¸­": 1, "å¾…è®€": 2 };

    // è©•åˆ†å€¼ 0â€“3 å°æ‡‰çš„ CSS class å¾Œç¶´ï¼ˆç©ºå­—ä¸² = ç„¡è©•åˆ†ï¼‰
    // ç”¨æ³•ï¼šspan class="rate two" â†’ å‰å…©é¡†åœ“é»å¡«è‰²
    const RATE_WORD = ["", "one", "two", "three"];

    // æŒä¹…åŒ–å„²å­˜çš„ keyï¼›åŠ ç‰ˆæœ¬è™Ÿæ–¹ä¾¿æœªä¾† schema å‡ç´šæ™‚æ¸…é™¤èˆŠè³‡æ–™
    const STORAGE_KEY = "bookInventory_v1";

    // é¦–æ¬¡è¼‰å…¥æˆ–ç„¡å„²å­˜è³‡æ–™æ™‚ä½¿ç”¨çš„é è¨­æ›¸å–®
    const DEFAULT_BOOKS = [
      { title: "ã€Šè§£æ†‚é›œè²¨åº—ã€‹", author: "æ±é‡åœ­å¾", genre: "å°èªª", status: "read", rate: 3 },
      { title: "ã€Šæ³¢è¥¿å‚‘å…‹æ£®ã€‹ç³»åˆ—", author: "ç‘å…‹Â·èŠçˆ¾é “", genre: "å¥‡å¹»", status: "read", rate: 2 },
      { title: "ã€Šå æ˜Ÿè¡“æ®ºäººäº‹ä»¶ã€‹", author: "å³¶ç”°èŠå¸", genre: "æ¨ç†", status: "read", rate: 3 },
      { title: "ã€Šç©ºæ´çš„åå­—æ¶ã€‹", author: "æ±é‡åœ­å¾", genre: "æ¨ç†", status: "read", rate: 3 },
      { title: "ã€Šé‡‘é–£å¯ºã€‹", author: "ä¸‰å³¶ç”±ç´€å¤«", genre: "å°èªª", status: "in-progress", rate: 0 },
      { title: "ã€Šç©¹ç›§ä¸‹çš„é­”å¥³ã€‹", author: "Tomato Soup", genre: "å¥‡å¹»", status: "in-progress", rate: 0 },
      { title: "ã€Šæƒ¡ä¹‹è¯ã€‹", author: "æ³¢ç‰¹èŠçˆ¾", genre: "è©©é›†", status: "to-read", rate: 0 },
    ];


    // ============================================================
    // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹è®Šæ•¸
    // ============================================================

    let books = [];    // æ›¸ç±é™£åˆ—ï¼ˆæ‰€æœ‰è³‡æ–™çš„å”¯ä¸€ä¾†æºï¼‰
    let editIdx = -1;  // ç›®å‰ç·¨è¼¯çš„æ›¸ç±ç´¢å¼•ï¼›-1 ä»£è¡¨æ–°å¢æ¨¡å¼
    let starVal = 0;   // Modal å…§ç›®å‰é¸å–çš„æ˜Ÿæ˜Ÿæ•¸ï¼ˆ0â€“3ï¼‰
    let sortCol = -1;  // ç›®å‰æ’åºæ¬„ä½ç´¢å¼•ï¼›-1 ä»£è¡¨å°šæœªæ’åº
    let asc = true;    // æ’åºæ–¹å‘ï¼štrue = å‡åºï¼Œfalse = é™åº

    // ä¸‰å€‹ç¯©é¸æ¢ä»¶ï¼ˆç”± applyFilter() è®€å– DOM å¾Œæ›´æ–°ï¼‰
    let filterText = "";  // é—œéµå­—ï¼ˆæ›¸å / ä½œè€… / é¡åˆ¥ï¼‰
    let filterStatus = "";  // é–±è®€ç‹€æ…‹ keyï¼ˆ"read" ç­‰ï¼‰æˆ– ""ï¼ˆä¸é™ï¼‰
    let filterRate = "";  // è©•åˆ†é–€æª»å­—ä¸²æˆ– ""ï¼ˆä¸é™ï¼‰


    // ============================================================
    // loadDataï¼šå¾æŒä¹…åŒ–å„²å­˜è®€å–æ›¸å–®ï¼Œå¤±æ•—å‰‡ç”¨é è¨­æ›¸å–®
    // ============================================================
    async function loadData() {
      try {
        const res = await window.storage.get(STORAGE_KEY);
        // res ç‚º null è¡¨ç¤º key ä¸å­˜åœ¨ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰â†’ è¤‡è£½é è¨­æ›¸å–®
        books = res ? JSON.parse(res.value) : [...DEFAULT_BOOKS];
      } catch {
        // JSON è§£æå¤±æ•—æˆ–å…¶ä»–éŒ¯èª¤ â†’ å®‰å…¨é€€å›é è¨­æ›¸å–®
        books = [...DEFAULT_BOOKS];
      }
      render();
      updateStats();
    }


    // ============================================================
    // saveDataï¼šå°‡æ›¸å–®åºåˆ—åŒ–å¾Œå¯«å…¥æŒä¹…åŒ–å„²å­˜ï¼Œä¸¦é¡¯ç¤º Toast
    // ============================================================
    let toastTimer = null; // é˜²æ­¢å¤šæ¬¡å¿«é€Ÿå„²å­˜æ™‚ Toast é‡è¤‡è¨ˆæ™‚

    async function saveData() {
      try {
        await window.storage.set(STORAGE_KEY, JSON.stringify(books));
        showToast("âœ“ å·²è‡ªå‹•å„²å­˜");
      } catch {
        showToast("âš  å„²å­˜å¤±æ•—");
      }
    }


    // ============================================================
    // showToastï¼šé¡¯ç¤ºå³ä¸‹è§’æç¤ºè¨Šæ¯ï¼Œduration ms å¾Œè‡ªå‹•æ¶ˆå¤±
    // ============================================================
    function showToast(msg, duration = 2000) {
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");        // CSS transition è§¸ç™¼æ·¡å…¥ä¸Šæ»‘
      clearTimeout(toastTimer);        // è‹¥å‰ä¸€å€‹è¨ˆæ™‚å™¨æœªçµæŸï¼Œå…ˆæ¸…é™¤
      toastTimer = setTimeout(() => el.classList.remove("show"), duration);
    }


    // ============================================================
    // rateHTMLï¼šä¾è©•åˆ†å€¼ç”¢ç”Ÿä¸‰é¡†è©•åˆ†åœ“é»çš„ HTML å­—ä¸²
    // ç¯„ä¾‹ï¼šrateHTML(2) â†’ <span class="rate two">â€¦</span>
    // CSS ç”¨ class åç¨±æ±ºå®šå“ªå¹¾é¡†åœ“é»è¦å¡«è‰²
    // ============================================================
    function rateHTML(r) {
      const word = RATE_WORD[r] || "";  // å–å¾— "one" / "two" / "three" æˆ– ""
      // ä¸‰å€‹å­ <span> ä»£è¡¨ä¸‰é¡†åœ“é»ï¼ŒCSS é¸æ“‡å™¨æ§åˆ¶å¡«è‰²æ•¸é‡
      return `<span class="${word ? `rate ${word}` : "rate"}"><span></span><span></span><span></span></span>`;
    }


    // ============================================================
    // updateStatsï¼šé‡æ–°è¨ˆç®—å„ç‹€æ…‹æ›¸ç±æ•¸é‡ä¸¦å¯«å…¥çµ±è¨ˆé¢æ¿
    // ============================================================
    function updateStats() {
      document.getElementById("s-total").textContent = books.length;
      document.getElementById("s-read").textContent = books.filter(b => b.status === "read").length;
      document.getElementById("s-prog").textContent = books.filter(b => b.status === "in-progress").length;
      document.getElementById("s-tor").textContent = books.filter(b => b.status === "to-read").length;
    }


    // ============================================================
    // getFilteredï¼šä¾ç›®å‰ä¸‰å€‹ç¯©é¸æ¢ä»¶éæ¿¾ books
    // å›å‚³ [{ book, origIdx }, ...] çµæ§‹ï¼Œä¿ç•™åŸå§‹ç´¢å¼•
    // â†’ è®“ render() åœ¨æŒ‰éˆ• onclick ä¸­èƒ½ç”¨ origIdx æ“ä½œæ­£ç¢ºæ›¸ç±
    // ============================================================
    function getFiltered() {
      return books
        .map((b, i) => ({ book: b, origIdx: i }))  // å…ˆè¨˜éŒ„åŸå§‹ç´¢å¼•
        .filter(({ book: b }) => {

          // --- é—œéµå­—æ¯”å°ï¼ˆæ›¸å / ä½œè€… / é¡åˆ¥ï¼Œä»»ä¸€ç¬¦åˆå³é€šéï¼‰---
          const kw = filterText;
          const matchText = !kw
            || b.title.toLowerCase().includes(kw)
            || b.author.toLowerCase().includes(kw)
            || b.genre.toLowerCase().includes(kw);

          // --- ç‹€æ…‹æ¯”å°ï¼ˆfilterStatus ç‚ºç©ºå­—ä¸²æ™‚ç•¥éæ­¤æ¢ä»¶ï¼‰---
          const matchStatus = !filterStatus || b.status === filterStatus;

          // --- è©•åˆ†æ¯”å° ---
          let matchRate = true;
          if (filterRate !== "") {
            const rv = parseInt(filterRate);
            // rv === 0ï¼šåƒ…é¡¯ç¤ºã€Œå°šæœªè©•åˆ†ã€ï¼ˆrate === 0ï¼‰
            // rv >= 1ï¼šé¡¯ç¤ºè©•åˆ†å¤§æ–¼ç­‰æ–¼ rv çš„æ›¸ç±
            matchRate = rv === 0 ? b.rate === 0 : b.rate >= rv;
          }

          return matchText && matchStatus && matchRate;
        });
    }


    // ============================================================
    // renderï¼šæ ¹æ“šç¯©é¸çµæœé‡æ–°ç”¢ç”Ÿ tbody çš„æ‰€æœ‰ <tr>
    // ============================================================
    function render() {
      const tbody = document.getElementById("tbody");
      const filtered = getFiltered();

      // ç„¡ç¬¦åˆçµæœæ™‚é¡¯ç¤ºæç¤ºè¨Šæ¯åˆ—
      if (!filtered.length) {
        tbody.innerHTML = `<tr class="empty-row"><td colspan="6">æ‰¾ä¸åˆ°ç¬¦åˆçš„æ›¸ç± ğŸ”</td></tr>`;
        return;
      }

      // ç”¨ origIdxï¼ˆåŸå§‹é™£åˆ—ç´¢å¼•ï¼‰è®“ç·¨è¼¯ / åˆªé™¤æŒ‰éˆ•èƒ½æ­£ç¢ºå®šä½æ›¸ç±
      tbody.innerHTML = filtered.map(({ book: b, origIdx }) => `
        <tr class="${b.status}">
          <td>${b.title}</td>
          <td>${b.author}</td>
          <td>${b.genre}</td>
          <td><span class="status">${STATUS_LABEL[b.status]}</span></td>
          <td data-rate="${b.rate}">${rateHTML(b.rate)}</td>
          <td class="action-cell">
            <button class="btn-edit" onclick="openModal(${origIdx})">âœ ç·¨è¼¯</button>
            <button class="btn-del"  onclick="deleteBook(${origIdx})">âœ• åˆªé™¤</button>
          </td>
        </tr>`).join("");
    }


    // ============================================================
    // applyFilterï¼šè®€å–ç›®å‰ DOM æ§åˆ¶å…ƒä»¶çš„å€¼ï¼Œæ›´æ–°ç¯©é¸æ¢ä»¶å¾Œé‡ç¹ª
    // ç”±æœå°‹æ¬„ï¼ˆoninputï¼‰èˆ‡ä¸‹æ‹‰é¸å–®ï¼ˆonchangeï¼‰è§¸ç™¼
    // ============================================================
    function applyFilter() {
      filterText = document.getElementById("searchInput").value.trim().toLowerCase();
      filterStatus = document.getElementById("filterStatus").value;
      filterRate = document.getElementById("filterRate").value;
      render();
    }


    // ============================================================
    // setStarï¼šé»æ“Šæ˜Ÿæ˜ŸæŒ‰éˆ•æ™‚æ›´æ–° starVal ä¸¦åŒæ­¥æŒ‰éˆ•æ¨£å¼
    // é‚è¼¯ï¼šé»æ“Šå·²é¸ä¸­çš„åŒä¸€é¡† â†’ å–æ¶ˆï¼ˆæ­¸é›¶ï¼‰ï¼›å¦å‰‡è¨­ç‚ºè©²å€¼
    // ============================================================
    function setStar(v) {
      starVal = (starVal === v) ? 0 : v;

      // é‡æ–°å¥—ç”¨æ‰€æœ‰æ˜Ÿæ˜ŸæŒ‰éˆ•çš„ .active ç‹€æ…‹
      document.querySelectorAll(".star-btn").forEach(btn => {
        // åˆ†å€¼ <= starVal çš„æŒ‰éˆ•éƒ½è¦äº®èµ·ï¼ˆä¾‹å¦‚é¸ 2 â†’ ç¬¬ 1ã€2 é¡†äº®ï¼‰
        btn.classList.toggle("active", parseInt(btn.dataset.v) <= starVal);
      });
    }


    // ============================================================
    // openModalï¼šé–‹å•Ÿ Modal
    // idx = -1 â†’ æ–°å¢æ¨¡å¼ï¼ˆæ¸…ç©ºè¡¨å–®ï¼‰
    // idx >= 0 â†’ ç·¨è¼¯æ¨¡å¼ï¼ˆå¸¶å…¥è©²æ›¸ç±è³‡æ–™ï¼‰
    // ============================================================
    function openModal(idx = -1) {
      editIdx = idx;
      starVal = 0;

      // å…ˆé‡ç½®æ‰€æœ‰æ˜Ÿæ˜ŸæŒ‰éˆ•ç‚ºæœªé¸å–ç‹€æ…‹
      document.querySelectorAll(".star-btn").forEach(b => b.classList.remove("active"));

      if (idx === -1) {
        // æ–°å¢æ¨¡å¼ï¼šæ¸…ç©ºæ¬„ä½ï¼Œç‹€æ…‹é è¨­ã€Œå¾…è®€ã€
        document.getElementById("modalTitle").textContent = "æ–°å¢æ›¸ç±";
        ["f-title", "f-author", "f-genre"].forEach(id =>
          document.getElementById(id).value = ""
        );
        document.getElementById("f-status").value = "to-read";
      } else {
        // ç·¨è¼¯æ¨¡å¼ï¼šå°‡æ›¸ç±è³‡æ–™å¡«å…¥è¡¨å–®
        const b = books[idx];
        document.getElementById("modalTitle").textContent = "ç·¨è¼¯æ›¸ç±";
        document.getElementById("f-title").value = b.title;
        document.getElementById("f-author").value = b.author;
        document.getElementById("f-genre").value = b.genre;
        document.getElementById("f-status").value = b.status;

        // æ¢å¾©åŸæœ¬è©•åˆ†ä¸¦é»äº®å°æ‡‰æ˜Ÿæ˜Ÿ
        starVal = b.rate;
        document.querySelectorAll(".star-btn").forEach(btn => {
          btn.classList.toggle("active", parseInt(btn.dataset.v) <= starVal);
        });
      }

      // åŠ ä¸Š .open â†’ CSS å°‡ display åˆ‡ç‚º flexï¼ŒModal é¡¯ç¤º
      document.getElementById("overlay").classList.add("open");
    }


    // ============================================================
    // closeModalï¼šç§»é™¤ .open classï¼Œéš±è— Modal
    // ============================================================
    function closeModal() {
      document.getElementById("overlay").classList.remove("open");
    }


    // ============================================================
    // saveBookï¼šé©—è­‰ä¸¦å„²å­˜æ›¸ç±ï¼ˆæ–°å¢ or æ›´æ–°ï¼‰
    // ============================================================
    function saveBook() {
      const title = document.getElementById("f-title").value.trim();
      const author = document.getElementById("f-author").value.trim();
      const genre = document.getElementById("f-genre").value.trim();
      const status = document.getElementById("f-status").value;

      // æ›¸åç‚ºå¿…å¡«æ¬„ä½
      if (!title) { alert("æ›¸åä¸å¯ç©ºç™½"); return; }

      const entry = { title, author, genre, status, rate: starVal };

      if (editIdx === -1) {
        books.push(entry);       // æ–°å¢ï¼šé™„åŠ åˆ°é™£åˆ—æœ«ç«¯
      } else {
        books[editIdx] = entry;  // ç·¨è¼¯ï¼šç›´æ¥è¦†è“‹åŸæœ‰ç‰©ä»¶
      }

      closeModal();
      render();
      updateStats();
      saveData();
    }


    // ============================================================
    // deleteBookï¼šç¢ºèªå¾Œåˆªé™¤æŒ‡å®šç´¢å¼•çš„æ›¸ç±
    // ============================================================
    function deleteBook(idx) {
      if (!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${books[idx].title}ã€ï¼Ÿ`)) return;

      books.splice(idx, 1);  // å¾ books é™£åˆ—ä¸­ç§»é™¤è©²å…ƒç´ 
      render();
      updateStats();
      saveData();
    }


    // ============================================================
    // sortTableï¼šé»æ“Šè¡¨é ­æ¬„ä½æ™‚æ’åº
    // colï¼šæ¬„ä½ç´¢å¼•ï¼ˆ0=æ›¸å, 1=ä½œè€…, 2=é¡åˆ¥, 3=ç‹€æ…‹, 4=è©•åˆ†ï¼‰
    // åŒä¸€æ¬„å†æ¬¡é»æ“Š â†’ åˆ‡æ›å‡/é™åºï¼›ä¸åŒæ¬„ â†’ é‡ç½®ç‚ºå‡åº
    // ============================================================
    function sortTable(col) {
      const ths = document.querySelectorAll("th");

      if (sortCol === col) {
        asc = !asc;   // åŒæ¬„ï¼šåˆ‡æ›æ–¹å‘
      } else {
        sortCol = col;
        asc = true;   // æ›æ¬„ï¼šé è¨­å‡åº
      }

      // æ›´æ–°è¡¨é ­è¦–è¦ºï¼šé«˜äº®ç›®å‰æ’åºæ¬„ï¼Œä¸¦æ›´æ–°ç®­é ­ç¬¦è™Ÿ
      ths.forEach((th, i) => {
        th.classList.toggle("active", i === col);
        const icon = th.querySelector(".sort-icon");
        if (icon) icon.textContent = (i === col) ? (asc ? "â†‘" : "â†“") : "â†•";
      });

      // æ’åº books é™£åˆ—ï¼ˆç›´æ¥ä¿®æ”¹æºè³‡æ–™ï¼Œrender() å†å‘ˆç¾ï¼‰
      books.sort((a, b) => {
        let va, vb;

        if (col === 3) {
          // ç‹€æ…‹æ¬„ï¼šä¾ STATUS_ORDER æ•¸å­—æ¯”è¼ƒï¼Œè€Œéå­—ä¸²
          va = STATUS_ORDER[STATUS_LABEL[a.status]] ?? 99;
          vb = STATUS_ORDER[STATUS_LABEL[b.status]] ?? 99;
        } else if (col === 4) {
          // è©•åˆ†æ¬„ï¼šç›´æ¥æ¯”è¼ƒæ•¸å€¼
          va = a.rate;
          vb = b.rate;
        } else {
          // æ–‡å­—æ¬„ï¼ˆæ›¸å / ä½œè€… / é¡åˆ¥ï¼‰ï¼šå­—ä¸²æ¯”è¼ƒ
          const keyMap = ["title", "author", "genre"];
          va = a[keyMap[col]];
          vb = b[keyMap[col]];
        }

        return va < vb ? (asc ? -1 : 1)
          : va > vb ? (asc ? 1 : -1)
            : 0;
      });

      render();
    }


    // ============================================================
    // é»æ“Šé®ç½©èƒŒæ™¯ï¼ˆoverlayï¼‰æ™‚é—œé–‰ Modal
    // ç”¨ e.target === e.currentTarget ç¢ºä¿åªæœ‰é»åˆ°é®ç½©æœ¬èº«æ‰è§¸ç™¼ï¼Œ
    // é»æ“Š Modal å…§éƒ¨å…ƒç´ ä¸æœƒæ„å¤–é—œé–‰
    // ============================================================
    document.getElementById("overlay").addEventListener("click", e => {
      if (e.target === e.currentTarget) closeModal();
    });


    // ============================================================
    // åˆå§‹åŒ–ï¼šé é¢è¼‰å…¥å¾Œè®€å–è³‡æ–™ä¸¦æ¸²æŸ“
    // ============================================================
    loadData();
  </script>
</body>

</html>