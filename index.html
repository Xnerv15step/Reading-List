<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8">
  <title>æ›¸ç±æ¸…å–®</title>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>

  <h1>æ›¸ç± <span>æ¸…å–®</span></h1>

  <!-- ===== çµ±è¨ˆé¢æ¿ ===== -->
  <div class="stats">
    <div class="stat-card total">
      <div class="val" id="s-total">0</div>
      <div class="lbl">ç¸½è¨ˆ</div>
    </div>
    <div class="stat-card read">
      <div class="val" id="s-read">0</div>
      <div class="lbl">å·²è®€</div>
    </div>
    <div class="stat-card prog">
      <div class="val" id="s-prog">0</div>
      <div class="lbl">é€²è¡Œä¸­</div>
    </div>
    <div class="stat-card toread">
      <div class="val" id="s-tor">0</div>
      <div class="lbl">å¾…è®€</div>
    </div>
  </div>

  <!-- ===== å·¥å…·åˆ— ===== -->
  <div class="toolbar">
    <div class="search-wrap">
      <span class="ico">ğŸ”</span>
      <input id="searchInput" type="text" placeholder="æœå°‹æ›¸åã€ä½œè€…ã€é¡åˆ¥â€¦" oninput="applyFilter()">
    </div>
    <select class="filter-select" id="filterStatus" onchange="applyFilter()">
      <option value="">å…¨éƒ¨ç‹€æ…‹</option>
      <option value="read">å·²è®€</option>
      <option value="in-progress">é€²è¡Œä¸­</option>
      <option value="to-read">å¾…è®€</option>
    </select>
    <select class="filter-select" id="filterRate" onchange="applyFilter()">
      <option value="">å…¨éƒ¨è©•åˆ†</option>
      <option value="3">â­â­â­ ä¸‰é¡†</option>
      <option value="2">â­â­ äºŒé¡†ä»¥ä¸Š</option>
      <option value="1">â­ ä¸€é¡†ä»¥ä¸Š</option>
      <option value="0">å°šæœªè©•åˆ†</option>
    </select>
    <button class="btn-add" onclick="openModal()">ï¼‹ æ–°å¢æ›¸ç±</button>
  </div>

  <!-- ===== ä¸»è¡¨æ ¼ ===== -->
  <table id="bookTable">
    <thead>
      <tr>
        <th onclick="sortTable(0)">æ›¸å <span class="sort-icon">â†•</span></th>
        <th onclick="sortTable(1)">ä½œè€… <span class="sort-icon">â†•</span></th>
        <th onclick="sortTable(2)">é¡åˆ¥ <span class="sort-icon">â†•</span></th>
        <th onclick="sortTable(3)">ç‹€æ…‹ <span class="sort-icon">â†•</span></th>
        <th onclick="sortTable(4)">è©•åˆ† <span class="sort-icon">â†•</span></th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <!-- ===== Toast ===== -->
  <div class="toast" id="toast">âœ“ å·²è‡ªå‹•å„²å­˜</div>

  <!-- ===== Modal ===== -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <h2 id="modalTitle">æ–°å¢æ›¸ç±</h2>
      <div class="form-group"><label>æ›¸å</label><input id="f-title" type="text" placeholder="è«‹è¼¸å…¥æ›¸å"></div>
      <div class="form-group"><label>ä½œè€…</label><input id="f-author" type="text" placeholder="è«‹è¼¸å…¥ä½œè€…"></div>
      <div class="form-group"><label>é¡åˆ¥</label><input id="f-genre" type="text" placeholder="å°èªªã€æ¨ç†ã€å¥‡å¹»â€¦"></div>
      <div class="form-group">
        <label>ç‹€æ…‹</label>
        <select id="f-status">
          <option value="read">å·²è®€</option>
          <option value="in-progress">é€²è¡Œä¸­</option>
          <option value="to-read">å¾…è®€</option>
        </select>
      </div>
      <div class="form-group">
        <label>è©•åˆ†(0~3é¡†)</label>
        <div class="star-picker">
          <button class="star-btn" data-v="1" onclick="setStar(1)">â—</button>
          <button class="star-btn" data-v="2" onclick="setStar(2)">â—</button>
          <button class="star-btn" data-v="3" onclick="setStar(3)">â—</button>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn-save" onclick="saveBook()">å„²å­˜</button>
      </div>
    </div>
  </div>

  <script>
    const STATUS_LABEL = { "read": "å·²è®€", "in-progress": "é€²è¡Œä¸­", "to-read": "å¾…è®€" };
    const STATUS_ORDER = { "å·²è®€": 0, "é€²è¡Œä¸­": 1, "å¾…è®€": 2 };
    const RATE_WORD = ["", "one", "two", "three"];
    const STORAGE_KEY = "bookInventory_v1";

    const DEFAULT_BOOKS = [
      { title: "ã€Šè§£æ†‚é›œè²¨åº—ã€‹", author: "æ±é‡åœ­å¾", genre: "å°èªª", status: "read", rate: 3 },
      { title: "ã€Šæ³¢è¥¿å‚‘å…‹æ£®ã€‹ç³»åˆ—", author: "ç‘å…‹Â·èŠçˆ¾é “", genre: "å¥‡å¹»", status: "read", rate: 2 },
      { title: "ã€Šå æ˜Ÿè¡“æ®ºäººäº‹ä»¶ã€‹", author: "å³¶ç”°èŠå¸", genre: "æ¨ç†", status: "read", rate: 3 },
      { title: "ã€Šç©ºæ´çš„åå­—æ¶ã€‹", author: "æ±é‡åœ­å¾", genre: "æ¨ç†", status: "read", rate: 3 },
      { title: "ã€Šé‡‘é–£å¯ºã€‹", author: "ä¸‰å³¶ç”±ç´€å¤«", genre: "å°èªª", status: "in-progress", rate: 0 },
      { title: "ã€Šç©¹ç›§ä¸‹çš„é­”å¥³ã€‹", author: "Tomato Soup", genre: "å¥‡å¹»", status: "in-progress", rate: 0 },
      { title: "ã€Šæƒ¡ä¹‹è¯ã€‹", author: "æ³¢ç‰¹èŠçˆ¾", genre: "è©©é›†", status: "to-read", rate: 0 },
    ];

    let books = [], editIdx = -1, starVal = 0, sortCol = -1, asc = true;
    let filterText = "", filterStatus = "", filterRate = "";

    async function loadData() {
      try {
        const res = await window.storage.get(STORAGE_KEY);
        books = res ? JSON.parse(res.value) : [...DEFAULT_BOOKS];
      } catch { books = [...DEFAULT_BOOKS]; }
      render(); updateStats();
    }

    let toastTimer = null;
    async function saveData() {
      try { await window.storage.set(STORAGE_KEY, JSON.stringify(books)); showToast("âœ“ å·²è‡ªå‹•å„²å­˜"); }
      catch { showToast("âš  å„²å­˜å¤±æ•—"); }
    }

    function showToast(msg, duration = 2000) {
      const el = document.getElementById("toast");
      el.textContent = msg; el.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => el.classList.remove("show"), duration);
    }

    function rateHTML(r) {
      const word = RATE_WORD[r] || "";
      return `<span class="${word ? `rate ${word}` : "rate"}"><span></span><span></span><span></span></span>`;
    }

    function updateStats() {
      document.getElementById("s-total").textContent = books.length;
      document.getElementById("s-read").textContent = books.filter(b => b.status === "read").length;
      document.getElementById("s-prog").textContent = books.filter(b => b.status === "in-progress").length;
      document.getElementById("s-tor").textContent = books.filter(b => b.status === "to-read").length;
    }

    function getFiltered() {
      return books.map((b, i) => ({ book: b, origIdx: i })).filter(({ book: b }) => {
        const kw = filterText;
        const matchText = !kw || b.title.toLowerCase().includes(kw) || b.author.toLowerCase().includes(kw) || b.genre.toLowerCase().includes(kw);
        const matchStatus = !filterStatus || b.status === filterStatus;
        let matchRate = true;
        if (filterRate !== "") {
          const rv = parseInt(filterRate);
          matchRate = rv === 0 ? b.rate === 0 : b.rate >= rv;
        }
        return matchText && matchStatus && matchRate;
      });
    }

    function render() {
      const tbody = document.getElementById("tbody");
      const filtered = getFiltered();
      if (!filtered.length) {
        tbody.innerHTML = `<tr class="empty-row"><td colspan="6">æ‰¾ä¸åˆ°ç¬¦åˆçš„æ›¸ç± ğŸ”</td></tr>`;
        return;
      }
      tbody.innerHTML = filtered.map(({ book: b, origIdx }) => `
        <tr class="${b.status}">
          <td>${b.title}</td><td>${b.author}</td><td>${b.genre}</td>
          <td><span class="status">${STATUS_LABEL[b.status]}</span></td>
          <td data-rate="${b.rate}">${rateHTML(b.rate)}</td>
          <td class="action-cell">
            <button class="btn-edit" onclick="openModal(${origIdx})">âœ ç·¨è¼¯</button>
            <button class="btn-del"  onclick="deleteBook(${origIdx})">âœ• åˆªé™¤</button>
          </td>
        </tr>`).join("");
    }

    function applyFilter() {
      filterText = document.getElementById("searchInput").value.trim().toLowerCase();
      filterStatus = document.getElementById("filterStatus").value;
      filterRate = document.getElementById("filterRate").value;
      render();
    }

    function setStar(v) {
      starVal = starVal === v ? 0 : v;
      document.querySelectorAll(".star-btn").forEach(btn => {
        btn.classList.toggle("active", parseInt(btn.dataset.v) <= starVal);
      });
    }

    function openModal(idx = -1) {
      editIdx = idx; starVal = 0;
      document.querySelectorAll(".star-btn").forEach(b => b.classList.remove("active"));
      if (idx === -1) {
        document.getElementById("modalTitle").textContent = "æ–°å¢æ›¸ç±";
        ["f-title", "f-author", "f-genre"].forEach(id => document.getElementById(id).value = "");
        document.getElementById("f-status").value = "to-read";
      } else {
        const b = books[idx];
        document.getElementById("modalTitle").textContent = "ç·¨è¼¯æ›¸ç±";
        document.getElementById("f-title").value = b.title;
        document.getElementById("f-author").value = b.author;
        document.getElementById("f-genre").value = b.genre;
        document.getElementById("f-status").value = b.status;
        starVal = b.rate;
        document.querySelectorAll(".star-btn").forEach(btn => {
          btn.classList.toggle("active", parseInt(btn.dataset.v) <= starVal);
        });
      }
      document.getElementById("overlay").classList.add("open");
    }

    function closeModal() { document.getElementById("overlay").classList.remove("open"); }

    function saveBook() {
      const title = document.getElementById("f-title").value.trim();
      const author = document.getElementById("f-author").value.trim();
      const genre = document.getElementById("f-genre").value.trim();
      const status = document.getElementById("f-status").value;
      if (!title) { alert("æ›¸åä¸å¯ç©ºç™½"); return; }
      const entry = { title, author, genre, status, rate: starVal };
      if (editIdx === -1) books.push(entry); else books[editIdx] = entry;
      closeModal(); render(); updateStats(); saveData();
    }

    function deleteBook(idx) {
      if (!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${books[idx].title}ã€ï¼Ÿ`)) return;
      books.splice(idx, 1); render(); updateStats(); saveData();
    }

    function sortTable(col) {
      const ths = document.querySelectorAll("th");
      if (sortCol === col) asc = !asc; else { sortCol = col; asc = true; }
      ths.forEach((th, i) => {
        th.classList.toggle("active", i === col);
        const icon = th.querySelector(".sort-icon");
        if (icon) icon.textContent = i === col ? (asc ? "â†‘" : "â†“") : "â†•";
      });
      books.sort((a, b) => {
        let va, vb;
        if (col === 3) { va = STATUS_ORDER[STATUS_LABEL[a.status]] ?? 99; vb = STATUS_ORDER[STATUS_LABEL[b.status]] ?? 99; }
        else if (col === 4) { va = a.rate; vb = b.rate; }
        else { const k = ["title", "author", "genre"]; va = a[k[col]]; vb = b[k[col]]; }
        return va < vb ? (asc ? -1 : 1) : va > vb ? (asc ? 1 : -1) : 0;
      });
      render();
    }

    document.getElementById("overlay").addEventListener("click", e => {
      if (e.target === e.currentTarget) closeModal();
    });

    loadData();
  </script>
</body>

</html>